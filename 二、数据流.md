# 数据流

[toc]

## 概率计数

### 问题描述

考虑这样一个计数器问题：数据流中只有一种数据，也就是“按动计数器”操作。你的计数器可能随时被查询总共被按了多少次

这个问题十分平凡，一个精确算法如下：

* 维护一个数 $n$，初始时为 0
* 计数器被按动时，令 $n\gets n + 1$
* 查询时，返回 $n$

显然我们需要 $\Theta(\log n)$ 个比特来维护这个数据

但是实际上算法可以使用更少的空间。以下给出一个空间复杂度为 $\order{\log\log n}$ 的算法（Morris）

* 维护一个数 $X$，初始时为 $0$
* 计数器被按动时，以 $2^{-X}$ 的概率令 $X\gets X + 1$
* 查询时，返回 $\tilde n = 2^X - 1$

### 算法分析

>  只要 $\mathbb E\qty[\tilde n] = n$ 且 ${\rm Var}\qty[\tilde n]$ 不太大，那么我们可以使用切比雪夫不等式来证明算法以很大的概率输出与真实值很接近。我们首先证明 $\mathbb E\qty[\tilde n] = n$

设 $X_n$ 是按下计数器 $n$ 次后 $X$ 的值

**引理：**$\mathbb E\qty[2^{X_n}] = n + 1$

>  我们尝试找出 $\mathbb E\qty[2^{X_{n + 1}}]$ 与 $\mathbb E\qty[2^{X_n}]$ 之间的关系
>
> 假如 $X_n = j$，那么我们很容易得出 $X_{n + 1}$ 的分布：有 $2^{-j}$ 的概率变成 $j + 1$，有 $1 - 2^{-j}$ 的概率不变。以此可以求出 $X_n = j$ 的时候 $X_{n + 1}$ 的期望。同时 $X_n = j$ 的时候 $X_n$ 的期望就是 $j$，我们在这个基础上进行递推

**证明：**考虑到 $X_0 = 0$ 即 $\mathbb E\qty[2^{X_0}] = 1$，而且
$$
\begin{aligned}
\mathbb E\qty[2^{X_{n + 1}}] &= \sum_{j = 0}^{\infty}\mathbb E\qty[2^{X_{n + 1}} | X_n = j]\mathbb P[X_n = j]\\
&= \sum_{j = 0}^{\infty} \qty(2^{j + 1}\cdot \mathbb P\qty[X_{n + 1} = j + 1 | X_n = j] + 2^j\cdot\mathbb P\qty[X_{n + 1} = j | X_n = j])\mathbb P\qty[X_n = j]\\
&= \sum_{j = 0}^\infty \qty(2^{j + 1}\cdot 2^{-j} + 2^j\cdot (1 - 2^{-j}))\mathbb P\qty[X_n = j]\\
&= \sum_{j = 0}^\infty\qty(2^j + 1)\mathbb P\qty[X_n = j]\\
&= \sum_{j = 0}^\infty 2^j\mathbb P\qty[X_n = j] + \sum_{j = 0}^{\infty}\mathbb P\qty[X_n = j]\\
&= \mathbb E[2^{X_n}] + 1
\end{aligned}
$$
很容易递推得到 $\mathbb E\qty[2^{X_n}] = n + 1$

由以上引理与 $\tilde n = 2^{X_n} - 1$ 可以得知 $\mathbb E\qty[\tilde n] = n$

> 然后我们求出 ${\rm Var}\qty[\tilde n]$，使用与前文类似的方法

观察到 ${\rm Var}\qty[\tilde n] = {\rm Var}\qty[2^{X_n}] = \mathbb E\qty[\qty(2^{X_n})^2] - \mathbb E^2\qty[2^{X_n}] = \mathbb E\qty[2^{2X_n}] - (n + 1)^2$。我们首先求出 $\mathbb E\qty[2^{2X_n}]$

考虑到 $X_0 = 0$ 即 $\mathbb E\qty[2^{2X_0}] = 1$，而且
$$
\begin{aligned}
\mathbb E\qty[2^{2X_{n + 1}}] &= \sum_{j = 0}^{\infty}\mathbb E\qty[2^{2X_{n + 1}} | X_n = j]\mathbb P[X_n = j]\\
&= \sum_{j = 0}^{\infty} \qty(2^{2j + 2}\cdot \mathbb P\qty[X_{n + 1} = j + 1 | X_n = j] + 2^{2j}\cdot\mathbb P\qty[X_{n + 1} = j | X_n = j])\mathbb P\qty[X_n = j]\\
&= \sum_{j = 0}^\infty \qty(2^{2j + 2}\cdot 2^{-j} + 2^{2j}\cdot (1 - 2^{-j}))\mathbb P\qty[X_n = j]\\
&= \sum_{j = 0}^\infty\qty(2^{2j} + 3\cdot 2^j)\mathbb P\qty[X_n = j]\\
&= \sum_{j = 0}^\infty 2^{2j}\mathbb P\qty[X_n = j] + 3\sum_{j = 0}^\infty2^j\mathbb P\qty[X_n = j]\\
&= \mathbb E[2^{2X_n}] + 3\mathbb E\qty[2^{X_n}]\\
&= \mathbb E\qty[2^{2X_n}] + 3(n + 1)
\end{aligned}
$$
易知
$$
\mathbb E\qty[2^{2X_n}] = \mathbb E\qty[2^{2X_0}] + \sum_{i = 0}^{n - 1}3(i + 1) = \frac 32n^2 + \frac 32n + 1
$$
所以
$$
{\rm Var}\qty[\tilde n] = {\rm Var}\qty[2^{X_n}] = \mathbb E\qty[2^{2X_n}] - \mathbb E^2\qty[2^{X_n}] = \frac 32n^2 + \frac 32 n + 1 - (n + 1)^2 = \frac{n^2}2 - \frac n2 = \order{n^2}
$$
这样切比雪夫不等式就可以估计出相对误差的概率
$$
\mathbb P\qty[\abs{\tilde n - n} > \epsilon n]\leq \frac{{\rm Var}\qty[\tilde n]}{\epsilon^2 n^2} = \order{\epsilon^{-2}}
$$

> 很遗憾，这个式子没啥用，代入 $\epsilon = 1$，这个式子不能表明本算法的误差小于 100%

